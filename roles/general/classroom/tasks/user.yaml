---

- name: Setup classroom user
  block:
    - name: Ensure user exists
      become: true
      ansible.builtin.user:
        name: '{{ classroom.user.name | mandatory }}'
        groups: 'adm,cdrom,sudo,dip,plugdev,lpadmin,lxd'
        shell: '/bin/bash'
        create_home: true
        password: ''
        remove: '{{ destroy | bool }}'
        force: '{{ destroy | bool }}'
        state: '{{ "absent" if destroy | bool else "present" }}'

    - name: Ensure SSH keys of all classroom admins are present in authorized_keys
      become: true
      ansible.posix.authorized_key:
        user: '{{ classroom.user.name | mandatory }}'
        state: present
        key: '{{ item.ssh_key | mandatory }}'
      loop: '{{ classroom.admin | default([]) }}'
      when: not destroy | bool


