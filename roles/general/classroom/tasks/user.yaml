---

- name: Setup classroom user
  block:
    - name: Ensure user exists
      become: true
      ansible.builtin.user:
        name: '{{ classroom.user.name | mandatory }}'
        groups: 'adm,cdrom,sudo,dip,plugdev,lpadmin,lxd,dialout'
        shell: '/bin/bash'
        create_home: true
        password: ''
        remove: '{{ destroy | bool }}'
        force: '{{ destroy | bool }}'
        state: '{{ "absent" if destroy | bool else "present" }}'

    - name: Ensure SSH keys of all classroom admins are present in authorized_keys
      become: true
      ansible.posix.authorized_key:
        user: '{{ classroom.user.name | mandatory }}'
        state: present
        key: '{{ item.ssh_key | mandatory }}'
      loop: '{{ classroom.admins | mandatory }}'
      when: not destroy | bool

    - name: Deploy admin SSH key
      become: true
      ansible.builtin.copy:
        dest: '/home/{{ classroom.user.name | mandatory }}/.ssh/{{ item }}'
        content: '{{ admin_ssh_key.privateKey if item == "id_ed25519" else admin_ssh_key.publicKey }}'
        owner: '{{ classroom.user.name | mandatory }}'
        group: '{{ classroom.user.name | mandatory }}'
        mode: '0600'
      loop: &ssh_key_list
        - id_ed25519
        - id_ed25519.pub
      when: is_admin_host | default(false) | bool and not destroy | bool

    - name: Ensure admin SSH key is absent
      become: true
      ansible.builtin.file:
        path: '/home/{{ classroom.user.name | mandatory }}/.ssh/{{ item }}'
        state: absent
      loop: *ssh_key_list
      when: not is_admin_host | default(false) | bool or destroy | bool
