---

- name: Initialise code directory
  block:
    - name: Ensure empty code directory exists
      when: code_init | bool
      ansible.builtin.file:
        path: '{{ code_dir }}'
        state: '{{ item }}'
        mode: '0755'
        owner: '{{ classroom.user.name | mandatory }}'
        group: '{{ classroom.user.name | mandatory }}'
      with_items:
        - absent
        - directory

    - name: Initialise repo
      when: git_init | bool
      shell: |
        git init -b main
        git config core.sparseCheckout true
        git remote add origin {{ code_repo_url }}
      args:
        chdir: '{{ code_dir }}'
        creates: '{{ code_dir }}/.git'

    - name: Checkout course
      shell: |
        git sparse-checkout set --no-cone "{{ repo_subdir | default("sketchbook/") }}"
        git fetch origin
        git reset --hard origin/main
      args:
        chdir: '{{ code_dir }}'
